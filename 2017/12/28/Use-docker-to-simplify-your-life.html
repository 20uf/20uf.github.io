<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="Michael COULLERET aka 20uf">
        <meta name="robots" content="noindex">

        <title>Michael COULLERET aka 20uf Utilisez docker pour simplifier votre vie!</title>

        <link href="css/bootstrap.mco.min.css" rel="stylesheet">
        <link href="css/theme.css" rel="stylesheet">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="//file.myfontastic.com/n6vo44Re5QaWo8oCKShBs7/icons.css" rel="stylesheet">
        <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
        <link href="//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    </head>

    <body>
    
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header page-scroll">
                    <button type="button" class="navbar-toggle" data-toggle="collapse"
                            data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="https://www.coulleret.pro">Michael COULLERET aka 20uf</a>
                </div>

                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="https://www.coulleret.pro">Qui suis-je ?</a>
                        </li>
                                                                                                                        <li>
                                        <a href="../../../index.html">
                                            Blog
                                        </a>
                                    </li>
                                                                                                        </ul>
                </div>
            </div>
        </nav>

        <header>
            <div class="container">
                <div class="row">
                    <img class="img-responsive img-circle photo col-lg-2" src="https://20uf.github.io/img/mc.png" alt="">
                    <div class="col-lg-10 intro-text">
                        <p class="skills">Architecte PHP</p>
                        <p>Symfony confirm√© et Zend Certified PHP Engineer</p>
                        <ul class="list-inline">
                            <li>
                                <a href="https://fr.linkedin.com/in/michael-coulleret/" class="btn-social btn-outline" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a>
                            </li>
                            <li>
                                <a href="http://fr.viadeo.com/fr/profile/michael.coulleret" class="btn-social btn-outline" target="_blank"><i class="fa fa-viadeo" aria-hidden="true"></i></a>
                            </li>
                            <li>
                                <a href="https://twitter.com/Mike20uf" class="btn-social btn-outline" target="_blank"><i class="fa fa-fw fa-twitter"></i></a>
                            </li>
                            <li>
                                <a href="https://github.com/20uf" class="btn-social btn-outline" target="_blank"><i class="fa fa-github-alt" aria-hidden="true"></i></a>
                            </li>
                        </ul>
                        <hr class="star-light">
                    </div>
                </div>
            </div>
        </header>

                <section class="container content">
                                                <h1></h1>
                            
              <article>
    <p class="text-muted">
      <span class="glyphicon glyphicon-calendar"></span>
      28 Dec 2017
    </p>

    <div class="body">
      <h2 id="utilisez-docker-pour-simplifier-votre-vie">Utilisez docker pour simplifier votre vie!<a href="#utilisez-docker-pour-simplifier-votre-vie" class="anchor">#</a></h2>
<h4 id="pourquoi-s-orienter-sur-du-docker">Pourquoi s'orienter sur du docker.<a href="#pourquoi-s-orienter-sur-du-docker" class="anchor">#</a></h4>
<p>Dans le cadre de mes projets j'ai &eacute;t&eacute; confront&eacute; &agrave; ce que chacun de mes d&eacute;veloppeurs se retrouvent avec des configurations diff&eacute;rentes sur leur poste de travail. </p>
<p>Selon les projets cette pratique peut &ecirc;tre probl&eacute;matique, par exemple nous avons application centrale qui permet l'authentification entre plusieurs produits et qui exploitent du [SSO].
La contrainte principale est le partage de session, les vhosts doivent &ecirc;tre identiques ainsi que la configuration applicative.</p>
<p>A mon sens &ccedil;a rend le projet complexe, il faut comprendre comment fonctionne le produit et les techniques utilis&eacute;es, il faut appr&eacute;hender et cela prend du temps.</p>
<p>La mise en oeuvre de [Docker] nous apporte les avantages suivants:</p>
<ul><li>L'installation d'un projet ne prend que quelque minutes, pr&ecirc;t au developpement.</li>
<li>La stack entre chaque d&eacute;veloppeurs est ISO</li>
<li>Le poste du d&eacute;veloppeur n&eacute;ccessite que cinq outils:
<ul><li>[Docker]</li>
<li>[Docker-compose]</li>
<li>[Git]</li>
<li>[Make]</li>
<li>Un IDE</li>
</ul></li>
</ul><h4 id="quelle-approche-aborder">Quelle approche aborder ?<a href="#quelle-approche-aborder" class="anchor">#</a></h4>
<p>La philosophie de [Docker] est de lancer un processus par conteneur. </p>
<p>En tant que d&eacute;veloppeur je pr&eacute;f&egrave;re avoir une approche diff&eacute;rente, par services.</p>
<p>Je connais mon silo, &agrave; savoir:</p>
<ul><li>Un clusteur Apache / Nginx et PHP-x</li>
<li>Un clusteur Mysql / MariaDb / MongoDb..</li>
<li>Un clusteur Memcache / Redis..</li>
</ul><p>Mon objectif est de s'approcher au maximum de cet environnement.</p>
<p><img src="/img/1_silo_docker.png" alt="Silo"></p>
<p>Pour cela je vais utiliser [Docker-compose] et [Make] pour simplifier la gestion:</p>
<ul><li>Installer le projet</li>
<li>Lancer les containers</li>
<li>Arr&ecirc;ter les containers</li>
<li>Manipuler un container (lancer des t&acirc;ches par exemple)</li>
</ul><p>Ma pratique est d'avoir un package <code>Docker</code> &agrave; la racine de mes projets, on peut y placer des <code>Dockerfile</code> qui peuvent &ecirc;tre construites &agrave; la demande.</p>
<p>Cependant je pr&eacute;f&egrave;re construire mes images en amont afin d'&eacute;conomiser le temps de construction &agrave; chaque installation. </p>
<p>Nous avons (mon &eacute;quipe) cr&eacute;&eacute; un d&eacute;p&ocirc;t [PHPDocker] qui contient une s&eacute;rie d'images, cela nous permet de pouvoir switcher facilement et simplement sur l'une d'elle.
Ces images repr&eacute;sentes la partie serveur web avec son langage (PHP) et des configurations adapt&eacute;es &agrave; nos besoins.</p>
<p>D&eacute;pot officiel: <a href="https://github.com/OsLab/docker-php-nginx">https://github.com/OsLab/docker-php-nginx</a></p>
<p>Voici la liste des images actuellement disponibles sous Debian Stetch (9):</p>
<p>PHP 7.2:</p>
<ul><li>dockerphp/nginx:7.2-stretch </li>
</ul><p>PHP 7.1:</p>
<pre><code class="language-yaml">* dockerphp/nginx:7.1-stretch</code></pre>
<p>PHP 7.0:</p>
<pre><code class="language-yaml">* dockerphp/nginx:7.0-stretch</code></pre>
<p>Il existe une version PHP 5.6 sous debian Jessie (8):</p>
<pre><code class="language-yaml">* dockerphp/nginx:5.6-jessie</code></pre>
<blockquote>
<p>Des Alpines seront prochainement ajout&eacute;es.</p>
</blockquote>
<h4 id="mise-en-place-du-silo">Mise en place du Silo<a href="#mise-en-place-du-silo" class="anchor">#</a></h4>
<p>Nos produits sont d&eacute;velopp&eacute;s sous Symfony, nos exemples sont donc bas&eacute;s dessus, vous pouvez bien &eacute;videmment reproduire pour tout autre type de Framework ou pas.</p>
<p>Notre fichier docker <code>docker-compose.yml</code> se trouvant &agrave; la racine du projet.</p>
<p>Je vous invite &agrave; consulter la [documentation officielle][docker-compose-refs] concernant l'utilisation et les r&eacute;f&eacute;rences.</p>
<pre><code class="language-yaml">version: "2"

services:
    app:
        image: dockerphp/nginx:7.2-stretch
        depends_on:
            - db
            - memcached_1
            - memcached_2
        volumes:
            - .:/app
        ports:
            - "8080:443"
        extra_hosts:
         - "sso.domain-dev.fr:172.17.0.1" # L'ip du docker engine

    db:
        image: mariadb:10.3
        environment:
            v: root
        ports:
            - "3301:3306"

    memcached_1:
        image: memcached:latest
        mem_limit: 1g

    memcached_2:
        image: memcached:latest
        mem_limit: 1g

    pma:
        image: phpmyadmin/phpmyadmin
        depends_on:
            - db
        environment:
            PMA_HOST: db
            PMA_USER: root
            PMA_PASSWORD: root
        ports:
            - "127.0.0.1:8081:80"</code></pre>
<p>D&eacute;taillons un peu cette configuration:</p>
<p><code>app</code>: </p>
<ul><li>Nous chargeons l'image avec Nginx et PHP 7.1.</li>
<li>Nous avons trois liens, un sur la base de donn&eacute;es et deux sur memcached.</li>
<li>le port 80 du container sera accessible sur le port 8080. (<a href="https://localhost:8080">https://localhost:8080</a>)</li>
<li>Nous ajoutons dans le <code>/etc/hosts</code> le domaine <code>sso.domain-dev.fr</code> sur l'ip du docker engine.</li>
</ul><p><code>db</code>: </p>
<ul><li>Nous chargeons l'image officielle de mariadb sur la version 10.3.
_ On d&eacute;clare avec la variable d'environnement <code>MYSQL_ROOT_PASSWORD</code> le mot de passe <code>root</code>.</li>
<li>le port 3306 du container sera accessible sur le port 3301.</li>
</ul><p><code>memcached_1</code> et <code>memcached_2</code>: </p>
<ul><li>Nous chargeons l'image officielle de memcached sur sa derni&egrave;re version.</li>
<li>On assigne 1g de m&eacute;moire &agrave; memcached .</li>
<li>le port 11211 du container sera accessible sur le port 11210 et 11211.</li>
</ul><p><code>pma</code>: </p>
<ul><li>Nous chargeons l'image officielle de phpmyadmin sur sa derni&egrave;re version.</li>
<li>Nous avons un lien avec la base de donn&eacute;es.</li>
<li>On d&eacute;clare avec les variables d'environnements pour que phpmyadmin se connecte &agrave; la base de donn&eacute;es.</li>
<li>le port 80 du container sera accessible sur le port 8081. (<a href="http://localhost:8081">http://localhost:8081</a>)</li>
</ul><p>Nous allons maintenant cr&eacute;er un fichier <code>Makefile</code> &agrave; la racine du projet, celui-ci va nous simplifier la vie pour manipuler les containers.</p>
<pre><code class="language-bash"># Do not change
DC=docker-compose
RUN=$(DC) run --rm app
EXEC=$(DC) exec app
CONSOLE=bin/console

.DEFAULT_GOAL := help
.PHONY: help start stop restart clear cc bash host deps

help:
    @echo ''
    @fgrep -h "##" $(MAKEFILE_LIST) | fgrep -v fgrep | sed -e 's/\\$$//' | sed -e 's/##//'
    @echo ''

## Setup
##---------------------------------------------------------------------------
install:        ## Install and start the project
install: up vendor app/config/parameters.yml yarn info

host:           ## Add the application host to your configuration
    @echo 'Adding the local domain to /etc/hosts'
    sudo sh -c  'echo "127.0.0.1       my-app.domain-dev.fr" &gt;&gt; /etc/hosts'

##
## Provisioning
##---------------------------------------------------------------------------
start:          ## start the project
start: up info

stop:           ## Stop docker containers
    $(DC) kill

restart:        ## Restart the whole project
restart: stop start warmup

bash:           ## Switch to the bash container of the application
    @$(RUN) bash

##
## Symfony
##---------------------------------------------------------------------------
clear:          ## Remove all the cache, the logs, the sessions and the built assets
clear: warmup

cc:             ## Clear the cache in dev env
cc:
    $(RUN) $(CONSOLE) cache:clear --no-warmup

clean:          ## Clean package nodejs
clean: clean_project

console:        ## Launch Console
    $(CONSOLE) $(filter-out $@,$(MAKECMDGOALS))

composer:       ## Launch Composer
    $(APP) composer $(filter-out $@,$(MAKECMDGOALS))

##
## Dependencies
##---------------------------------------------------------------------------

deps:           ## Install the project PHP and JS dependencies
deps: vendor

# Internal rules

up:
    $(DC) up -d --remove-orphans

warmup:
    -$(EXEC) rm -rf var/cache/*
    -$(EXEC) rm -rf var/sessions/*
    -$(EXEC) rm -rf var/logs/*

vendor: composer.lock
    @$(RUN) composer install

composer.lock: composer.json
    @echo compose.lock is not up to date.

app/config/parameters.yml: app/config/parameters.yml.dist
    @$(RUN) composer run-script post-install-cmd --no-interaction

node_modules: yarn.lock
    @$(RUN) yarn run assets

yarn:
    -$(EXEC) npm run yarn:assets

yarn.lock: package.json
    @echo yarn.lock is not up to date.

%:
@:</code></pre>
<p>Vous remarquez qu'il est assez simple d'ajouter de nouvelles t&acirc;ches.</p>
<p>Vous pouvez maintenant consulter les t&acirc;ches disponibles avec la commande:</p>
<pre><code>$ make</code></pre>
<p>Vous aurez pour r&eacute;sultat:</p>
<pre><code class="language-bash"> Setup
---------------------------------------------------------------------------
install:         Install and start the project
host:            Add the application host to your configuration

 Provisioning
---------------------------------------------------------------------------
start:           start the project
stop:            Stop docker containers
restart:         Restart the whole project
bash:            Switch to the bash App container of the application

 Cache
---------------------------------------------------------------------------
clear:           Remove all the cache, the logs, the sessions and the built assets
cc:              Clear the cache in dev env
clean:           Clean package nodejs

 Dependencies
---------------------------------------------------------------------------
deps:            Install the project PHP and JS dependencies</code></pre>
<p>Vous l'aurez compris, maintenant l'installation d'un projet semble simple et rapide, voici en quelques lignes ce que repr&eacute;sentent l'installation d'un projet:</p>
<pre><code>$ git clone git@gitlab.entreprise.com:namespace/project_name.git
Cloning into 'project_name'...
remote: Counting objects: 22512, done.
....
$ make install
cd project_name/ &amp;&amp; make install
docker-compose up -d --remove-orphans
Creating network "project_name_default" with the default driver
Pulling memcached (memcached:latest)...
latest: Pulling from library/memcached
94ed0c431eb5: Pull complete
...
7.2-stretch: Pulling from dockerphp/nginx
...</code></pre>
<p>Une fois termin&eacute;e vous pouvez acceder:</p>
<ul><li>A votre application sur <a href="https://my-app.domain-dev.fr:8080">https://my-app.domain-dev.fr:8080</a></li>
<li>PhpMyAdmin sur <a href="http://my-app.domain-dev.fr:8081">http://my-app.domain-dev.fr:8081</a></li>
<li>Mysql sur le port 3301 si vous utilisez MysqlWorkbench.</li>
</ul><h4 id="la-surcharge-des-configurations">La surcharge des configurations<a href="#la-surcharge-des-configurations" class="anchor">#</a></h4>
<p>Jusqu'ici nous avons mis en place notre stack, cependant nous avons besoin de surcharger la configuration de PHP, ou encore celle de Nginx.</p>
<p>Rien de plus simple! Il suffit de monter le ou les fichiers de configuration dans nos volumes !</p>
<pre><code class="language-yaml">services:
    app:
        image: dockerphp/nginx:7.2-stretch
        volumes:
            - .:/app
            - ./docker/nginx.conf:/etc/nginx/nginx.conf
            - ./docker/php.ini:/etc/php5/fpm/php.ini
```yaml

Rappelez-vous nous avions d&eacute;cid&eacute; en d&eacute;but de cet article cr&eacute;er un package `docker` &agrave; la racine de notre projet, nous allons y placer deux fichiers:
* php.ini
* nginx.conf

&gt; Vous pouvez trouver les configurations de base sur le [d&eacute;p&ocirc;t officiel](https://github.com/OsLab/docker-php-nginx/tree/master/image/config), les exemples ci-dessous sont d&eacute;monstratifs.

Surcharger `php.ini` pour ajouter l'&eacute;criture des sessions dans memcached.</code></pre>
<p>; Add here the parameters that you want to override</p>
<p>short_open_tag = Off
date.timezone = Europe/Paris
error_log = /proc/self/fd/2
upload_max_filesize = 10M
post_max_size = 10M
memory_limit=1024M</p>
<p>; <a href="https://symfony.com/doc/3.4/performance.html">https://symfony.com/doc/3.4/performance.html</a>
opcache.max_accelerated_files = 20000
realpath_cache_size=4096K
realpath_cache_ttl=600</p>
<p>; xdebug
xdebug.remote_enable=on
xdebug.remote_autostart=off
xdebug.remote_port=9000
xdebug.remote_handler=dbgp
xdebug.remote_connect_back=0</p>
<p>;session.save_handler=memcached
memcached session.save_path = 'tcp://memcached_1:11211,tcp://memcached_2:11211'</p>
<pre><code>
Surcharger `nginx.conf` pour changer le dossier public ou le vhost par exemple.</code></pre>
<p>daemon off;
user www-data;
worker_processes 5;
pid /run/nginx.pid;</p>
<p>error_log /dev/stdout info;</p>
<p>events {
worker_connections 1024;</p>
<h1 id="multi-accept-on">multi_accept on;<a href="#multi-accept-on" class="anchor">#</a></h1>
<p>}</p>
<p>http {
access_log /dev/stdout;</p>
<pre><code>##
# Basic Settings
##

sendfile on;
tcp_nopush on;
tcp_nodelay on;
keepalive_timeout 65;
types_hash_max_size 2048;
include /etc/nginx/mime.types;
default_type application/octet-stream;
types {
    font/woff2 woff2;
}
client_max_body_size 10M;

##
# Virtual Host Configs
##

server {
    listen 443 ssl;
    server_name oslab.demo.net;

    ssl on;
    ssl_certificate /etc/ssl/nginx/nginx.crt;
    ssl_certificate_key /etc/ssl/nginx/nginx.key;

    root /app/public;
    index index.php;

    location / {
        try_files $uri /index.php$is_args$args;
    }

    location ~ \.php(/|$) {
        internal;

        fastcgi_pass 127.0.0.1:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param SYMFONY_ENV dev;
        fastcgi_param HTTPS on;

        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }
}</code></pre>
<p>}</p>
<pre><code>

Pensez a relancer vos conteneurs pour que les modifications prennent effets.

Vous en pensez quoi ? Pas mal hein ? :)

[SSO]: https://fr.wikipedia.org/wiki/Authentification_unique
[Docker]: https://www.docker.com/
[Docker-compose]: https://docs.docker.com/compose/
[Make]: https://www.gnu.org/software/make/
[PHPDocker]: https://github.com/php-docker/nginx
[Hyper V]: https://fr.wikipedia.org/wiki/Hyper-V
[docker-compose-refs]: https://docs.docker.com/compose/compose-file/
[Git]: https://git-scm.com/
[Make]: https://www.gnu.org/software/make/</code></pre>
    </div>

          <hr>
      <h4><span class="glyphicon glyphicon-tags"></span>&nbsp;
                    <a href="../../../tags/docker.html"><span class="label label-primary">Docker</span></a>
                    <a href="../../../tags/docker-compose.html"><span class="label label-primary">Docker-Compose</span></a>
                    <a href="../../../tags/sandbox.html"><span class="label label-primary">Sandbox</span></a>
              </h4>
      </article>
        </section>
        
                            <footer class="container text-center">
                <small>Copyright &copy; Michael COULLERET 2016 - 2018.</small>
            </footer>
        

        <script src="https://use.fontawesome.com/1cb4261d3b.js"></script>
    </body>
</html>